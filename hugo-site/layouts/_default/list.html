{{ define "main" }}
  <!-- Breadcrumb -->
  <nav class="breadcrumb">
    <a href="/">Home</a>
    <span class="breadcrumb-separator">&rsaquo;</span>
    {{ if .IsSection }}
      <strong>{{ .Title }}</strong>
    {{ end }}
  </nav>

  <!-- Section Header -->
  <div class="section-header">
    <h1 class="section-title">{{ .Title }}</h1>
    {{ with .Params.description }}
      <p class="section-description">{{ . }}</p>
    {{ end }}
  </div>

  {{ with .Content }}
    <div class="section-body">
      {{ . | safeHTML }}
    </div>
  {{ end }}

  <!-- Articles List -->
  {{ $pages := .Pages | default .Site.RegularPages }}
  {{/* Build available languages via CSV accumulation */}}
  {{ $langScratch := newScratch }}
  {{ $langScratch.Set "langsCSV" "" }}
  {{ range $pages }}
    {{ with .Params.language }}
      {{ $langScratch.Add "langsCSV" (printf "%s," (lower .)) }}
    {{ end }}
  {{ end }}
  {{ $langs := slice }}
  {{ $langsCSV := $langScratch.Get "langsCSV" | default "" }}
  {{ if gt (len $langsCSV) 0 }}
    {{ $trimmed := trim $langsCSV "," }}
    {{ $langs = uniq (sort (split $trimmed ",")) }}
  {{ end }}
  {{ $defaultLang := "en" }}
  {{ $resolvedDefault := cond (in $langs $defaultLang) $defaultLang "all" }}
  {{ if gt (len $langs) 0 }}
    <div class="card-meta" style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; margin-bottom:1rem;">
      <label for="lang-filter" style="font-weight:700;">Language:</label>
      <select id="lang-filter" class="lang-select" data-default="{{ $resolvedDefault }}">
        <option value="all">ALL</option>
        {{ range $langs }}
          <option value="{{ . }}">{{ upper . }}</option>
        {{ end }}
      </select>
    </div>
    <script>
      (function(){
        var sel = document.getElementById('lang-filter');
        var cards = Array.prototype.slice.call(document.querySelectorAll('article.news-list-item'));
        var defaultValue = sel.getAttribute('data-default') || 'all';
        var storageKey = 'gcmsLanguageFilter';
        function readStored(){
          try { return localStorage.getItem(storageKey); } catch (_) { return null; }
        }
        function writeStored(val){
          try { localStorage.setItem(storageKey, val); } catch (_) {}
        }
        function apply(code){
          var c = (code || '').toLowerCase();
          cards.forEach(function(card){
            var lang = (card.getAttribute('data-lang') || '').toLowerCase();
            if (!c || c === 'all'){ card.style.display = ''; return; }
            card.style.display = (lang === c) ? '' : 'none';
          });
        }
        var url = new URL(window.location.href);
        var urlParam = url.searchParams.get('lang');
        var stored = readStored();
        var init = urlParam || stored || defaultValue;
        if (!Array.prototype.some.call(sel.options, function(o){ return o.value === init; })){
          init = defaultValue;
        }
        sel.value = init;
        apply(init);
        if (!urlParam && init && init !== 'all'){
          url.searchParams.set('lang', init);
          window.history.replaceState({}, '', url);
        }
        sel.addEventListener('change', function(){
          var code = sel.value;
          var url = new URL(window.location);
          if (code === 'all') url.searchParams.delete('lang'); else url.searchParams.set('lang', code);
          window.history.replaceState({}, '', url);
          if (code && code !== 'all'){ writeStored(code); } else { writeStored('all'); }
          apply(code);
        });
      })();
    </script>
  {{ end }}
  {{ if $pages }}
    {{ $orderedScratch := newScratch }}
    {{ $orderedScratch.Set "ordered" ($pages.ByDate.Reverse) }}
    {{ $sortHint := lower (.Params.list_sort | default "") }}
    {{ if eq $sortHint "weight" }}
      {{ $orderedScratch.Set "ordered" (sort $pages ".Params.weight") }}
    {{ else if eq $sortHint "weight_desc" }}
      {{ $orderedScratch.Set "ordered" ((sort $pages ".Params.weight").Reverse) }}
    {{ else if eq $sortHint "date_asc" }}
      {{ $orderedScratch.Set "ordered" ($pages.ByDate) }}
    {{ end }}
    {{ $ordered := $orderedScratch.Get "ordered" }}
    {{ $paginator := .Paginate $ordered }}
    <div id="articles" class="news-list news-list-grid">
      {{ range $paginator.Pages }}
        <article class="card news-list-item" data-lang="{{ with .Params.language }}{{ . | lower }}{{ end }}">
          {{ if or .Params.category .Params.language }}
            <div class="card-meta" style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
              {{ with .Params.category }}
                <span class="badge badge-category">{{ . }}</span>
              {{ end }}
              {{ partial "language-badge.html" . }}
            </div>
          {{ end }}

          <h2 class="card-title">
            <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          </h2>

          <div class="card-meta">
            {{ with .Params.author }}
              <span>By {{ . }}</span>
              {{ if or $.Date $.Params.source_url $.Params.feed }}<span>&bull;</span>{{ end }}
            {{ end }}
            {{ partial "news-date.html" . }}
            {{ with .Params.source_url }}
              <span>&bull;</span>
              <a href="{{ . }}" target="_blank" rel="noopener">Source</a>
            {{ end }}
            {{ with .Params.feed }}
              <span>&bull;</span>
              <span class="text-muted">{{ . | replaceRE "^https?://(www\\.)?" "" | replaceRE "/.*$" "" }}</span>
            {{ end }}
          </div>

          {{ with .Summary }}
            {{ $clean := replace (replace . "" "") "" "" }}
            <p class="card-summary">{{ $clean | plainify | truncate 200 }}</p>
          {{ end }}

          <a class="btn btn-link" href="{{ .RelPermalink }}">Read article â†’</a>
        </article>
      {{ end }}
    </div>
    {{ partial "pagination.html" . }}
    {{ partial "news-itemlist.html" (dict "pages" $paginator.Pages) }}
  {{ else }}
    <div class="card">
      <p class="text-muted">No entries yet in this section.</p>
    </div>
  {{ end }}
{{ end }}
