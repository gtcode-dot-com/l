<!DOCTYPE html>
{{- $siteLang := .Site.LanguageCode | default "en" -}}
{{- $contentLang := .Params.language | default "" -}}
{{- $langFromHugo := .Lang | default "" -}}
{{- $pageLang := cond (ne $contentLang "") $contentLang (cond (ne $langFromHugo "") $langFromHugo $siteLang) -}}
<html lang="{{ $pageLang }}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {{- $siteTitle := .Site.Title -}}
    {{- $homeSuffix := strings.TrimSpace (.Site.Params.home_title_suffix | default "") -}}
    {{- $pageTitle := cond .IsHome (cond (ne $homeSuffix "") (printf "%s 路 %s" $siteTitle $homeSuffix) $siteTitle) (printf "%s 路 %s" .Title $siteTitle) -}}
    <title>{{ $pageTitle }}</title>
    {{ $enableMath := or .Params.math .Site.Params.math }}

    <!-- Meta tags -->
    {{ partial "fetch-article-meta.html" (dict "context" .) }}
    {{ $articleMeta := .Scratch.Get "_article_meta" }}
    {{ if not $articleMeta }}
      {{ $articleMetaMap := default (dict) (index .Site.Data "article_meta") }}
      {{ $articleMeta = index $articleMetaMap (trim .RelPermalink "/") }}
    {{ end }}
    {{ $pageDescription := .Site.Params.description }}
    {{ if .Description }}{{ $pageDescription = .Description }}{{ end }}
    {{ with .Params.meta_description }}{{ $pageDescription = . }}{{ end }}
    {{ with $articleMeta.meta_description }}{{ $pageDescription = . }}{{ end }}
    <meta name="description" content="{{ $pageDescription }}" />
    <meta name="author" content="{{ .Site.Params.author }}" />
    {{ block "pagination-head" . }}{{ end }}
    {{ $headPaginator := .Scratch.Get "_head_paginator" }}
    {{ $robots := .Params.robots }}
    {{ if and (not $robots) $headPaginator (gt $headPaginator.PageNumber 1) }}
      {{ $robots = "noindex,follow" }}
    {{ end }}
    {{ if and (eq .Section "news") .Params.source_url (not .Params.news_original) }}
      {{ if not $robots }}
        {{ $robots = "noindex,follow" }}
      {{ end }}
    {{ end }}
    {{ with $robots }}
    <meta name="robots" content="{{ . }}" />
    {{ end }}
    {{ $keywords := "" }}
    {{ with .Params.meta_keywords }}
      {{ if (reflect.IsSlice .) }}
        {{ $keywords = delimit . ", " }}
      {{ else }}
        {{ $keywords = . }}
      {{ end }}
    {{ end }}
    {{ if eq $keywords "" }}
      {{ with $articleMeta.keywords }}
        {{ $keywords = delimit . ", " }}
      {{ end }}
    {{ end }}
    {{ if ne $keywords "" }}
      <meta name="keywords" content="{{ $keywords }}" />
    {{ end }}
    {{ $canonical := .Permalink }}
    {{ if .Params.canonical }}
      {{ $canonical = .Params.canonical }}
    {{ else if and (eq .Section "news") .Params.source_url (not .Params.news_original) }}
      {{ $canonical = .Params.source_url }}
    {{ else if and $headPaginator (gt $headPaginator.PageNumber 1) }}
      {{ $canonical = printf "%s%s" (strings.TrimRight "/" .Site.BaseURL) $headPaginator.URL }}
    {{ end }}
    {{ $canonical = replace $canonical "http://" "https://" }}
    <link rel="canonical" href="{{ $canonical }}" />
    {{ with .Site.Home.OutputFormats.Get "RSS" }}
    <link rel="alternate" type="application/rss+xml" title="{{ $.Site.Title }}" href="{{ .RelPermalink }}">
    {{ end }}
    {{ with .Site.Home.OutputFormats.Get "news-sitemap" }}
    <link rel="alternate" type="application/xml" title="{{ $.Site.Title }} News Sitemap" href="{{ .RelPermalink }}">
    {{ end }}
    {{ with .Site.GetPage "section" "news" }}
      {{ with .OutputFormats.Get "RSS" }}
    <link rel="alternate" type="application/rss+xml" title="{{ printf "%s News" $.Site.Title }}" href="{{ .RelPermalink }}">
      {{ end }}
    {{ end }}
    {{ $ogType := cond (eq .Section "news") "article" "website" }}
    {{ $ogImage := "/img/gtcode-core.svg" }}
    {{ with .Params.structured_data.main_image }}{{ $ogImage = . }}{{ end }}
    {{ with .Params.og_image }}{{ $ogImage = . }}{{ end }}
    {{ with $articleMeta.og_image }}{{ $ogImage = . }}{{ end }}
    {{ if hasPrefix $ogImage "/" }}{{ $ogImage = printf "%s%s" (strings.TrimRight "/" .Site.BaseURL) $ogImage }}{{ end }}
    {{ $ogImage = replace $ogImage "http://" "https://" }}
    <meta property="og:title" content="{{ .Title }} 路 {{ .Site.Title }}" />
    <meta property="og:locale" content="{{ $pageLang }}" />
    <meta property="og:description" content="{{ $pageDescription }}" />
    <meta property="og:type" content="{{ $ogType }}" />
    <meta property="og:url" content="{{ $canonical }}" />
    <meta property="og:image" content="{{ $ogImage }}" />
    <meta property="og:site_name" content="{{ .Site.Params.og_site_name | default .Site.Title }}" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="{{ .Title }} 路 {{ .Site.Title }}" />
    <meta name="twitter:description" content="{{ $pageDescription }}" />
    <meta name="twitter:image" content="{{ $ogImage }}" />

    <!-- CSS Reset -->
    {{ $resetCSS := resources.Get "css/reset.css" | minify | fingerprint }}
    <link rel="stylesheet" href="{{ $resetCSS.RelPermalink }}" integrity="{{ $resetCSS.Data.Integrity }}" crossorigin="anonymous" />

    <!-- Fonts (self-hosted) -->
    <link rel="stylesheet" href="/fonts/fonts.css" />
    <link rel="preload" as="image" href="{{ "/img/gtcode-core.svg" | relURL }}" type="image/svg+xml" />

    <!-- Main Stylesheet -->
    {{ $postcssOpts := dict "inlineImports" true "config" "postcss.config.js" }}
    {{ $mainCSS := resources.Get "css/main.css" | css.PostCSS $postcssOpts | minify | fingerprint }}
    <link rel="stylesheet" href="{{ $mainCSS.RelPermalink }}" integrity="{{ $mainCSS.Data.Integrity }}" crossorigin="anonymous" />
    {{ if $enableMath }}
    <link rel="stylesheet" href="/vendor/katex/katex.min.css" />
    {{ end }}

    {{ partial "jsonld.html" . }}

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/img/gtcode-core.svg" />
  </head>
  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <header class="site-header">
      <div class="site-header-inner">
        <a href="/" class="site-logo">
          <img src="/img/gtcode-badge.svg" alt="GTCode mark" class="site-logo-mark" width="40" height="40" loading="lazy" decoding="async" />
          <span>{{ .Site.Title }}</span>
        </a>
        <button class="site-nav-toggle" type="button" aria-controls="primary-nav" aria-expanded="false">
          <span class="sr-only">Toggle primary navigation</span>
          <span class="site-nav-toggle-icon" aria-hidden="true">
            <span class="site-nav-toggle-bar"></span>
            <span class="site-nav-toggle-bar"></span>
            <span class="site-nav-toggle-bar"></span>
          </span>
          <span class="site-nav-toggle-label">Menu</span>
        </button>
        <nav class="site-nav" id="primary-nav" aria-label="Primary navigation" tabindex="-1">
          <a href="/" {{ if .IsHome }}class="active"{{ end }}>Home</a>
          <a href="/investigation/" {{ if eq .Section "investigation" }}class="active"{{ end }}>Investigations</a>
          <a href="/guides/" {{ if eq .Section "guides" }}class="active"{{ end }}>Guides</a>
          <a href="/repos/" {{ if eq .Section "repos" }}class="active"{{ end }}>Repos</a>
          <a href="/articles/" {{ if eq .Section "articles" }}class="active"{{ end }}>Articles</a>
          {{ partial "news-nav.html" . }}
        </nav>
      </div>
    </header>
    <div class="site-nav-overlay" aria-hidden="true"></div>

    <main class="site-main" id="main-content">
      {{ partial "ai-agent-comment.html" . }}
      {{ block "main" . }}{{ end }}
    </main>

    <footer class="site-footer">
      <div class="site-footer-inner">
        <div class="footer-section">
          <h4>About</h4>
          <p class="text-muted">{{ .Site.Params.description }}</p>
        </div>
        <div class="footer-section">
          <h4>News</h4>
          {{- $newsData := .Site.Data.news_categories | default dict -}}
          {{- $categories := $newsData.categories | default slice -}}
          <ul>
            {{- if gt (len $categories) 0 -}}
              {{- range $categories -}}
                <li><a href="/news/{{ .slug }}/">{{ .title }}</a></li>
              {{- end -}}
            {{- else -}}
              <li><a href="/news/ai-security/">AI Security</a></li>
              <li><a href="/news/ai-research/">AI Research</a></li>
              <li><a href="/news/comp-journalism/">Computational Journalism</a></li>
            {{- end -}}
          </ul>
        </div>
        <div class="footer-section">
          <h4>Categories</h4>
          <ul>
            <li><a href="/guides/">Guides</a></li>
            <li><a href="/articles/">Articles</a></li>
            <li><a href="/repos/">Repos</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-copyright">
        &copy; {{ now.Format "2006" }}&nbsp;<a href="/">{{ .Site.Title }}</a>. Powered by GCMS.
      </div>
    </footer>
    {{ if $enableMath }}
    <script defer src="/vendor/katex/katex.min.js"></script>
    <script defer src="/vendor/katex/auto-render.min.js" onload="renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}]});"></script>
    {{ end }}
    {{ if or (.Store.Get "hasMermaid") (.Page.Store.Get "hasMermaid") }}
    <script src="/vendor/mermaid/mermaid.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        if (window.mermaid) {
          window.mermaid.initialize({
            startOnLoad: true,
            theme: "dark",
            securityLevel: "loose"
          });
        }
      });
    </script>
    {{ end }}
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const body = document.body;
        const toggle = document.querySelector(".site-nav-toggle");
        const nav = document.getElementById("primary-nav");
        const overlay = document.querySelector(".site-nav-overlay");

        if (!toggle || !nav) {
          return;
        }

        const mobileQuery = window.matchMedia("(max-width: 960px)");
        const syncNavState = function () {
          if (mobileQuery.matches) {
            nav.setAttribute("aria-hidden", body.classList.contains("nav-open") ? "false" : "true");
          } else {
            nav.removeAttribute("aria-hidden");
          }
        };

        const closeNav = function () {
          if (!body.classList.contains("nav-open")) {
            return false;
          }
          body.classList.remove("nav-open");
          toggle.setAttribute("aria-expanded", "false");
          syncNavState();
          return true;
        };

        const openNav = function () {
          if (body.classList.contains("nav-open")) {
            return;
          }
          body.classList.add("nav-open");
          toggle.setAttribute("aria-expanded", "true");
          syncNavState();
          const firstLink = nav.querySelector("a");
          if (firstLink) {
            firstLink.focus();
          }
        };

        body.classList.add("nav-ready");
        syncNavState();

        toggle.addEventListener("click", function () {
          if (body.classList.contains("nav-open")) {
            closeNav();
          } else {
            openNav();
          }
        });

        if (overlay) {
          overlay.addEventListener("click", closeNav);
        }

        nav.addEventListener("click", function (event) {
          if (event.target.closest("a") && mobileQuery.matches) {
            closeNav();
          }
        });

        document.addEventListener("keyup", function (event) {
          if (event.key === "Escape" && closeNav()) {
            toggle.focus();
          }
        });

        const mq = window.matchMedia("(min-width: 961px)");
        const mqHandler = function (event) {
          if (event.matches) {
            closeNav();
          }
          syncNavState();
        };

        if (mq.addEventListener) {
          mq.addEventListener("change", mqHandler);
        } else if (mq.addListener) {
          mq.addListener(mqHandler);
        }

        if (mobileQuery.addEventListener) {
          mobileQuery.addEventListener("change", syncNavState);
        } else if (mobileQuery.addListener) {
          mobileQuery.addListener(syncNavState);
        }
      });
    </script>
  </body>
</html>
