{{- $normalizedBase := replace .Site.BaseURL "http://" "https://" -}}
{{- $base := strings.TrimSuffix "/" $normalizedBase -}}
{{- $siteLastMod := .Site.Lastmod -}}
{{- $siteLastModString := "" -}}
{{- if not ($siteLastMod.IsZero) -}}
  {{- $siteLastModString = $siteLastMod.Format "2006-01-02" -}}
{{- else -}}
  {{- $siteLastModString = now.Format "2006-01-02" -}}
{{- end -}}
{{ printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>" | safeHTML }}
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:xhtml="http://www.w3.org/1999/xhtml">
  {{- /* Static assets that need explicit inclusion */ -}}
  {{- $staticEntries := slice
      (dict "loc" (replace (printf "%s/papers/ResearchProposal-ChiralNarrativeSynthesis_20250617.pdf" $base) "http://" "https://") "changefreq" "yearly" "priority" 0.70 "lastmod" "2025-07-30")
    -}}
  {{- range $static := $staticEntries }}
  <url>
    <loc>{{- printf "%s" $static.loc -}}</loc>
    <lastmod>{{- or $static.lastmod $siteLastModString -}}</lastmod>
    <changefreq>{{- $static.changefreq | default "monthly" -}}</changefreq>
    <priority>{{- printf "%.2f" (float ($static.priority | default 0.50)) -}}</priority>
  </url>
  {{- end }}

  {{- range sort .Data.Pages "RelPermalink" "asc" }}
    {{- $robots := lower (printf "%v" .Params.robots) -}}
    {{- $isNoindex := in $robots "noindex" -}}
    {{- $isSyndicatedNews := and (eq .Section "news") .Params.source_url (not .Params.news_original) -}}
    {{- if not (or $isNoindex $isSyndicatedNews) -}}
    {{- $lastmod := .Lastmod -}}
    {{- if $lastmod.IsZero }}{{ $lastmod = .PublishDate }}{{ end -}}
    {{- if $lastmod.IsZero }}{{ $lastmod = .Date }}{{ end -}}
    {{- if $lastmod.IsZero }}{{ $lastmod = $siteLastMod }}{{ end -}}
    {{- if $lastmod.IsZero }}{{ $lastmod = now }}{{ end -}}
    {{- $changefreq := .Sitemap.ChangeFreq -}}
    {{- if not $changefreq }}{{ $changefreq = "monthly" }}{{ end -}}
    {{- $priority := 0.50 -}}
    {{- $rawPriority := .Sitemap.Priority -}}
    {{- if and (ne $rawPriority nil) (ge (float $rawPriority) 0) }}
      {{- $priority = float $rawPriority -}}
    {{- end -}}
  <url>
    {{- $loc := printf "%s%s" $base .RelPermalink -}}
    {{- $loc = replace $loc "http://" "https://" -}}
    <loc>{{- printf "%s" $loc -}}</loc>
    {{- if not ($lastmod.IsZero) }}
    <lastmod>{{- $lastmod.Format "2006-01-02" -}}</lastmod>
    {{- end }}
    <changefreq>{{- $changefreq -}}</changefreq>
    <priority>{{- printf "%.2f" $priority -}}</priority>
  </url>
    {{- end -}}
  {{- end }}
</urlset>
