<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chapter 7: Advanced Optimization with DSPy | Building CNS 2.0: A Developer&#39;s Guide</title>
    <meta name="description" content="Evolving CNS 2.0 from prompt engineering to programmatic optimization using DSPy">
    <meta name="author" content="CNS Development Team">
    
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">
    
    
    <link rel="stylesheet" href="/css/style.css?v=1753859298">
    
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    




    
    
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
    <div class="site-wrapper">
        
        <header class="site-header">
            <div class="container">
                <nav class="main-nav">
                    <div class="nav-brand">
                        <a href="/guides/building-cns-2.0-developers-guide/" class="brand-link">
                            <span class="brand-icon">üß†</span>
                            <span class="brand-text">Building CNS 2.0: A Developer&#39;s Guide</span>
                        </a>
                    </div>
                    
                    <div class="nav-menu">
                        <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
                            <i data-feather="menu"></i>
                        </button>
                        
                        <ul class="nav-list">
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-1-introduction/" class="nav-link ">
                                        Introduction
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-2-sno-foundations/" class="nav-link ">
                                        SNO Foundations
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-3-critic-pipeline/" class="nav-link ">
                                        Critic Pipeline
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-4-synthesis-engine/" class="nav-link ">
                                        Synthesis Engine
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-5-system-integration/" class="nav-link ">
                                        System Integration
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-6-complete-implementation/" class="nav-link ">
                                        Complete Implementation
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-7-dspy-integration/" class="nav-link ">
                                        DSPy Integration
                                    </a>
                                </li>
                            
                        </ul>
                    </div>
                </nav>
            </div>
        </header>

        
        <main class="site-main">
            <div class="container">
                
<article class="content-article">
    
    <header class="article-header">
        <div class="article-meta">
            <span class="article-weight">Chapter 7 of 7</span>
            <span class="article-separator">‚Ä¢</span>
            <time class="article-date">July 29, 2025</time>
        </div>
        
        <h1 class="article-title">Chapter 7: Advanced Optimization with DSPy</h1>
        
        
        <p class="article-description">Evolving CNS 2.0 from prompt engineering to programmatic optimization using DSPy</p>
        
        
        
        <div class="progress-indicator">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 116.69000000000001%"></div>
            </div>
        </div>
    </header>

    
    <aside class="article-toc">
        <h3>Table of Contents</h3>
        <nav id="TableOfContents">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#from-prompt-engineering-to-programmatic-optimization">From Prompt Engineering to Programmatic Optimization</a>
      <ul>
        <li><a href="#from-paper-to-code-tackling-the-research-challenge">From Paper to Code: Tackling the Research Challenge</a></li>
      </ul>
    </li>
    <li><a href="#refactoring-ingestion-with-an-improved-dspy-metric">Refactoring Ingestion with an Improved DSPy Metric</a></li>
    <li><a href="#closing-the-loop-a-self-optimizing-synthesis-engine">Closing the Loop: A Self-Optimizing Synthesis Engine</a>
      <ul>
        <li><a href="#1-define-the-synthesis-signature">1. Define the Synthesis Signature</a></li>
        <li><a href="#2-create-the-synthesis-module">2. Create the Synthesis Module</a></li>
        <li><a href="#3-the-critic-pipeline-as-a-metric">3. The Critic Pipeline as a Metric</a></li>
        <li><a href="#4-compiling-the-self-optimizing-synthesizer">4. Compiling the Self-Optimizing Synthesizer</a></li>
      </ul>
    </li>
    <li><a href="#conclusion-from-blueprint-to-dynamic-system">Conclusion: From Blueprint to Dynamic System</a></li>
  </ul>
</nav>
        </nav>
    </aside>

    
    <div class="article-content">
        <div class="guide-header">
    <a href="/" class="home-link">‚Üê Back to GTCode.com Homepage</a>
</div>
<h1 id="chapter-7-advanced-optimization-with-dspy">Chapter 7: Advanced Optimization with DSPy</h1>
<h2 id="from-prompt-engineering-to-programmatic-optimization">From Prompt Engineering to Programmatic Optimization</h2>
<p>Our CNS 2.0 system relies on hand-crafted prompts to instruct LLMs. This approach has critical weaknesses: it&rsquo;s brittle across different LLM versions, hard to compose, and difficult to optimize. To create a truly robust, self-improving system, we must move from <em>prompting</em> to <em>programming</em>. This is where <strong>DSPy</strong> comes in.</p>
<p>DSPy is a framework for programming LLMs. We define the logic of our program and the metric we want to maximize, and DSPy&rsquo;s optimizers (or &ldquo;compilers&rdquo;) automatically find the best prompts and few-shot examples to achieve that goal.</p>
<h3 id="from-paper-to-code-tackling-the-research-challenge">From Paper to Code: Tackling the Research Challenge</h3>
<p>The CNS 2.0 paper identifies the <strong>Narrative Ingestion Pipeline</strong> as a &ldquo;major research challenge.&rdquo; DSPy provides the framework to solve this programmatically. Instead of guessing prompts to extract a hypothesis and claims, we can define what a &ldquo;good&rdquo; extraction looks like with a metric and let a DSPy optimizer do the work.</p>
<h2 id="refactoring-ingestion-with-an-improved-dspy-metric">Refactoring Ingestion with an Improved DSPy Metric</h2>
<p>Our first step is to refactor the ingestion pipeline with DSPy. A key improvement here is using a <strong>graded evaluation metric</strong> instead of a simple binary one. A graded metric provides a much richer signal to the optimizer, allowing it to find and refine partially correct solutions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Chapter 7: Optimizing Narrative Ingestion with DSPy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">===================================================
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Refactoring the CNS 2.0 Ingestion Pipeline for robustness and performance.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> dspy
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pydantic <span style="color:#f92672">import</span> BaseModel, Field
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- 1. Configure DSPy ---</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (Assume dspy.OpenAI is configured as before)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- 2. Define Structured Output ---</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExtractedClaim</span>(BaseModel):
</span></span><span style="display:flex;"><span>    claim_id: str <span style="color:#f92672">=</span> Field(description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;A unique identifier for the claim, e.g., &#39;claim_1&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>    content: str <span style="color:#f92672">=</span> Field(description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;The text content of the claim.&#34;</span>)
</span></span><span style="display:flex;"><span>    claim_type: str <span style="color:#f92672">=</span> Field(description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;The type of claim, e.g., &#39;premise&#39;, &#39;conclusion&#39;.&#34;</span>)
</span></span><span style="display:flex;"><span>    relationships: List[str] <span style="color:#f92672">=</span> Field(description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;List of claim_ids this claim supports or contradicts.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- 3. Define the DSPy Signature ---</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DocumentToSNO</span>(dspy<span style="color:#f92672">.</span>Signature):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Extracts the central hypothesis and a structured list of claims from a document.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    document_text: str <span style="color:#f92672">=</span> dspy<span style="color:#f92672">.</span>InputField(desc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;The full text of the source document.&#34;</span>)
</span></span><span style="display:flex;"><span>    central_hypothesis: str <span style="color:#f92672">=</span> dspy<span style="color:#f92672">.</span>OutputField(desc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;A single, concise sentence summarizing the document&#39;s main argument.&#34;</span>)
</span></span><span style="display:flex;"><span>    claims: List[ExtractedClaim] <span style="color:#f92672">=</span> dspy<span style="color:#f92672">.</span>OutputField(desc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;A structured list of key claims and their relationships from the document.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- 4. Create the DSPy Module ---</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SNOIngestionModule</span>(dspy<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span><span style="color:#a6e22e">__init__</span>()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>generate_structure <span style="color:#f92672">=</span> dspy<span style="color:#f92672">.</span>ChainOfThought(DocumentToSNO)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, document_text):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>generate_structure(document_text<span style="color:#f92672">=</span>document_text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- 5. Create a Graded Evaluation Metric ---</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">graded_sno_structure_metric</span>(example, pred, trace<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> float:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    A graded metric that provides partial credit for partially correct structures.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This gives the optimizer a much better signal for improvement.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    score <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Award points for a valid, non-trivial hypothesis</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> isinstance(pred<span style="color:#f92672">.</span>central_hypothesis, str) <span style="color:#f92672">and</span> len(pred<span style="color:#f92672">.</span>central_hypothesis) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">20</span>:
</span></span><span style="display:flex;"><span>            score <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Award points for a correctly typed list of claims</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> isinstance(pred<span style="color:#f92672">.</span>claims, list):
</span></span><span style="display:flex;"><span>            score <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0.25</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Award final points if the list contains valid ExtractedClaim objects</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> len(pred<span style="color:#f92672">.</span>claims) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">and</span> all(isinstance(c, ExtractedClaim) <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> pred<span style="color:#f92672">.</span>claims):
</span></span><span style="display:flex;"><span>                score <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0.25</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># The prediction was so malformed it caused an error.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> score
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### Why Use a Graded Metric?</span>
</span></span><span style="display:flex;"><span>A simple binary metric (e<span style="color:#f92672">.</span>g<span style="color:#f92672">.</span>, <span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">1.0</span><span style="color:#960050;background-color:#1e0010">`</span> <span style="color:#66d9ef">if</span> the structure <span style="color:#f92672">is</span> perfect, <span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0.0</span><span style="color:#960050;background-color:#1e0010">`</span> otherwise) provides a very weak signal to the DSPy optimizer<span style="color:#f92672">.</span> The optimizer works by trying different prompts, <span style="color:#f92672">and</span> <span style="color:#66d9ef">if</span> it only receives a score of <span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0.0</span><span style="color:#960050;background-color:#1e0010">`</span> <span style="color:#66d9ef">for</span> most of its attempts, it has no way of knowing <span style="color:#66d9ef">if</span> one failed attempt was <span style="color:#e6db74">&#34;more correct&#34;</span> than another<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>A <span style="color:#f92672">**</span>graded metric<span style="color:#f92672">**</span> that provides partial credit <span style="color:#f92672">is</span> far more effective<span style="color:#f92672">.</span> It creates a smoother optimization landscape<span style="color:#f92672">.</span> For example:
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> A prompt that correctly extracts the hypothesis but fails on the claims gets a score of <span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0.5</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> A prompt that gets the hypothesis <span style="color:#f92672">and</span> also produces a list (even <span style="color:#66d9ef">if</span> the list items are malformed) gets <span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0.75</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>This gradient gives the optimizer a clear direction <span style="color:#66d9ef">for</span> improvement<span style="color:#f92672">.</span> It can learn what works <span style="color:#66d9ef">for</span> one part of the output <span style="color:#f92672">and</span> then refine the prompt to solve the remaining parts, leading to much faster <span style="color:#f92672">and</span> more reliable optimization<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- 6. Optimize (Compile) the Module ---</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (The training examples and optimization process remain the same, but now use the graded metric)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># optimizer = BootstrapFewShot(metric=graded_sno_structure_metric, max_bootstrapped_demos=2)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># optimized_ingestion_module = optimizer.compile(SNOIngestionModule(), trainset=train_examples)</span>
</span></span></code></pre></div><p>This graded metric allows the DSPy compiler to &ldquo;hill-climb&rdquo; towards better prompts more effectively, rewarding prompts that, for example, correctly extract the hypothesis even if they fail on the claims structure.</p>
<h2 id="closing-the-loop-a-self-optimizing-synthesis-engine">Closing the Loop: A Self-Optimizing Synthesis Engine</h2>
<p>The true power of combining CNS 2.0 and DSPy is realized when we turn the system&rsquo;s critical judgment upon itself. We can use our own <strong>Critic Pipeline</strong> as the metric to optimize the <strong>Synthesis Engine</strong>. This creates a feedback loop where the system learns to generate syntheses that it itself considers to be high-quality. This fulfills the vision from the paper of a system capable of &ldquo;continuous improvement.&rdquo;</p>
<p>The diagram below illustrates this self-optimizing loop. The goal is to &ldquo;compile&rdquo; a <code>SynthesisModule</code> that is optimized to produce SNOs that score highly on our <code>CriticPipeline</code> metric.</p>
<div style="text-align: center;">
  <img src="/img/diagram-02.svg" alt="Centered SVG" style="display: inline-block;" />
</div>
<p>This process allows the system to programmatically discover what makes a &ldquo;good&rdquo; synthesis from its own perspective. It will tune the prompts and few-shot examples used by the <code>SynthesisModule</code> until it reliably produces outputs that are logical, well-grounded, and novel according to our own critics.</p>
<h3 id="1-define-the-synthesis-signature">1. Define the Synthesis Signature</h3>
<p>First, we define what we want the synthesis LLM to do. It should take two conflicting narratives and produce a new, unified hypothesis.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChiralPairToSynthesis</span>(dspy<span style="color:#f92672">.</span>Signature):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Given two conflicting narratives, generate a novel, higher-order hypothesis that resolves the conflict.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This signature defines the inputs and outputs for our synthesis task. The descriptions (`desc`)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    are crucial, as they are used by the DSPy optimizer to construct effective prompts.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    narrative_A: str <span style="color:#f92672">=</span> dspy<span style="color:#f92672">.</span>InputField(desc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;The first narrative, including its central hypothesis and key supporting claims.&#34;</span>)
</span></span><span style="display:flex;"><span>    narrative_B: str <span style="color:#f92672">=</span> dspy<span style="color:#f92672">.</span>InputField(desc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;The second, conflicting narrative, including its central hypothesis and key supporting claims.&#34;</span>)
</span></span><span style="display:flex;"><span>    shared_evidence: str <span style="color:#f92672">=</span> dspy<span style="color:#f92672">.</span>InputField(desc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;A summary of the key evidence that both narratives are trying to explain.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    synthesized_hypothesis: str <span style="color:#f92672">=</span> dspy<span style="color:#f92672">.</span>OutputField(desc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;A new, single-sentence hypothesis that resolves the conflict and synthesizes the core insights of both narratives.&#34;</span>)
</span></span></code></pre></div><h3 id="2-create-the-synthesis-module">2. Create the Synthesis Module</h3>
<p>Next, we create a DSPy module that uses this signature. A module is a reusable component that encapsulates a specific LLM behavior.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SynthesisModule</span>(dspy<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;A DSPy module for synthesizing conflicting narratives.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span><span style="color:#a6e22e">__init__</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># We define the LLM reasoning strategy here. `dspy.ChainOfThought` tells the LLM</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># to &#34;think step-by-step&#34; to arrive at the answer, which is effective for</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># complex reasoning tasks like synthesis.</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>synthesizer <span style="color:#f92672">=</span> dspy<span style="color:#f92672">.</span>ChainOfThought(ChiralPairToSynthesis)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, narrative_A, narrative_B, shared_evidence):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;The forward method defines how data flows through the module.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>synthesizer(narrative_A<span style="color:#f92672">=</span>narrative_A, narrative_B<span style="color:#f92672">=</span>narrative_B, shared_evidence<span style="color:#f92672">=</span>shared_evidence)
</span></span></code></pre></div><h3 id="3-the-critic-pipeline-as-a-metric">3. The Critic Pipeline as a Metric</h3>
<p>This is the core of the self-improvement loop. We create a metric function that takes a predicted <code>synthesized_hypothesis</code>, builds a new SNO from it, and then runs that SNO through our full <code>CriticPipeline</code>. The resulting <code>trust_score</code> is the metric that DSPy will try to maximize.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">critic_pipeline_metric</span>(cns_workflow_manager, example, pred, trace<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> float:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Uses the entire CNS critic pipeline to evaluate the quality of a synthesized hypothesis.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This function is the bridge between DSPy&#39;s optimization and our system&#39;s own judgment.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cns_workflow_manager: An instance of our main workflow manager to access the critics.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        example: The input example from the training set.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pred: The prediction object from the DSPy module.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        trace: The execution trace (unused here, but required by the metric signature).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        A float score from 0.0 to 1.0, where 1.0 is a perfect score.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 1. Extract the predicted hypothesis from the DSPy prediction object.</span>
</span></span><span style="display:flex;"><span>        synthesized_hypothesis <span style="color:#f92672">=</span> pred<span style="color:#f92672">.</span>synthesized_hypothesis
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 2. Perform basic validation. An invalid or trivial output gets the worst possible score.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(synthesized_hypothesis, str) <span style="color:#f92672">or</span> len(synthesized_hypothesis) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">20</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 3. Instantiate a candidate SNO from the LLM&#39;s generated hypothesis.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#    In a full implementation, you would also populate its reasoning graph and</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#    evidence set by combining elements from the parent SNOs in the `example`.</span>
</span></span><span style="display:flex;"><span>        candidate_sno <span style="color:#f92672">=</span> StructuredNarrativeObject(central_hypothesis<span style="color:#f92672">=</span>synthesized_hypothesis)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># We must compute its embedding to allow the Novelty critic to work.</span>
</span></span><span style="display:flex;"><span>        candidate_sno<span style="color:#f92672">.</span>compute_hypothesis_embedding(cns_workflow_manager<span style="color:#f92672">.</span>embedding_model)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 4. The Novelty Critic needs the existing SNO population to compare against.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#    We provide the full SNO population as context for the evaluation.</span>
</span></span><span style="display:flex;"><span>        context <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;sno_population&#39;</span>: cns_workflow_manager<span style="color:#f92672">.</span>sno_population}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 5. Run the candidate SNO through our complete, multi-component critic pipeline.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#    This is the core of the feedback loop.</span>
</span></span><span style="display:flex;"><span>        evaluation_result <span style="color:#f92672">=</span> cns_workflow_manager<span style="color:#f92672">.</span>critic_pipeline<span style="color:#f92672">.</span>evaluate_sno(candidate_sno, context)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 6. The final, holistic trust_score produced by our pipeline is the metric.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#    DSPy&#39;s optimizer will now tune the synthesizer&#39;s prompts to maximize this score.</span>
</span></span><span style="display:flex;"><span>        trust_score <span style="color:#f92672">=</span> evaluation_result<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;trust_score&#39;</span>, <span style="color:#ae81ff">0.0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> trust_score
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># If any part of the process fails (e.g., malformed prediction), return a score of 0.0.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># This penalizes prompts that produce unusable outputs.</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Critic pipeline metric failed: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0.0</span>
</span></span></code></pre></div><h3 id="4-compiling-the-self-optimizing-synthesizer">4. Compiling the Self-Optimizing Synthesizer</h3>
<p>With the signature, module, and metric defined, we can now compile our <code>SynthesisModule</code>. The optimizer will try different prompts and few-shot examples for the synthesis task, and for each attempt, it will check the quality of the output using the <code>critic_pipeline_metric</code>. It will learn to generate hypotheses that are well-grounded, logical, and novel <em>according to the system&rsquo;s own internal criteria</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Assume &#39;cns_manager&#39; is an instance of our CNSWorkflowManager containing the critic pipeline.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># We wrap our metric in a lambda function to pass the cns_manager instance into it.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This gives our metric access to the critics and the full SNO population.</span>
</span></span><span style="display:flex;"><span>metric_with_context <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> ex, pred, trace: critic_pipeline_metric(cns_manager, ex, pred, trace)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># We choose an optimizer. `BootstrapFewShot` is a powerful choice that generates</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># both high-quality prompts and effective few-shot examples for the module.</span>
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> BootstrapFewShot(metric<span style="color:#f92672">=</span>metric_with_context, max_bootstrapped_demos<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># We need a small set of training examples. These don&#39;t need to have &#34;correct&#34; output labels,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># as the metric provides the signal for what is good. We just need representative inputs.</span>
</span></span><span style="display:flex;"><span>synthesis_train_examples <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    dspy<span style="color:#f92672">.</span>Example(
</span></span><span style="display:flex;"><span>        narrative_A<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Hypothesis: AI regulation stifles innovation. Claims: Excessive rules slow down development.&#34;</span>,
</span></span><span style="display:flex;"><span>        narrative_B<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Hypothesis: AI regulation is essential for safety. Claims: Unchecked AI poses existential risks.&#34;</span>,
</span></span><span style="display:flex;"><span>        shared_evidence<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;The rapid development of large language models.&#34;</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#f92672">.</span>with_inputs(<span style="color:#e6db74">&#39;narrative_A&#39;</span>, <span style="color:#e6db74">&#39;narrative_B&#39;</span>, <span style="color:#e6db74">&#39;shared_evidence&#39;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ... more examples of conflicting pairs would be added here</span>
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This is the &#34;compilation&#34; step. The optimizer will run the SynthesisModule on the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># training examples, evaluate the outputs with our critic_pipeline_metric, and use the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># feedback to iteratively improve the prompts and few-shot examples inside the module.</span>
</span></span><span style="display:flex;"><span>optimized_synthesis_module <span style="color:#f92672">=</span> optimizer<span style="color:#f92672">.</span>compile(SynthesisModule(), trainset<span style="color:#f92672">=</span>synthesis_train_examples)
</span></span></code></pre></div><p>By integrating DSPy in this way, we have transformed the CNS 2.0 system from a static implementation into a dynamic, learning framework. It not only automates knowledge synthesis but now has the programmatic capability to get better at its own core task over time, truly fulfilling the vision of the original research paper.</p>
<h2 id="conclusion-from-blueprint-to-dynamic-system">Conclusion: From Blueprint to Dynamic System</h2>
<p>This guide has walked through the process of translating the CNS 2.0 research paper from a theoretical blueprint into a practical, working system. We have built each component step-by-step: the core <code>StructuredNarrativeObject</code>, the transparent <code>CriticPipeline</code>, the scalable <code>ChiralPairDetector</code>, and the <code>AdvancedSynthesisEngine</code>.</p>
<p>Finally, by integrating DSPy, we have shown a path from a static system to a dynamic one‚Äîa system that can programmatically optimize and improve its own reasoning capabilities. This closing of the loop, where the system&rsquo;s own judgment is used to refine its generative components, represents a key step toward the goal of automated, robust, and continuously improving knowledge discovery.</p>

    </div>

    
    <nav class="article-nav">
        <div class="nav-previous">
            
        </div>
        
        <div class="nav-next">
            
                <a href="/guides/building-cns-2.0-developers-guide/chapter-6-complete-implementation/" class="nav-link next-link">
                    <div class="nav-text">
                        <span class="nav-label">Previous</span>
                        <span class="nav-title">Chapter 6: Complete Implementation</span>
                    </div>
                    <i data-feather="arrow-left"></i>
                </a>
            
        </div>
    </nav>

    
    <aside class="chapter-summary">
        <h3>Chapter Summary</h3>
        <div class="summary-content">
            
                <p>Evolving the CNS 2.0 system from prompt engineering to programmatic optimization using DSPy.</p>
                <ul>
                    <li>Refactoring ingestion with DSPy Signatures</li>
                    <li>Building optimizable DSPy Modules</li>
                    <li>Metric-driven development and compilation</li>
                </ul>
            
        </div>
    </aside>
</article>

            </div>
        </main>

        
        <footer class="site-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-text">
                        <p>&copy; 2025 <a href="https://GTCode.com/" class="footer-link">GTCode.com</a>. Educational content for CNS 2.0 implementation.</p>
                        <p>Based on <a target="_blank" 
                               rel="noopener noreferrer" href="/papers/ResearchProposal-ChiralNarrativeSynthesis_20250617_3.pdf" class="footer-link">CNS 2.0: A Practical Blueprint for Chiral Narrative Synthesis</a> research paper. (20250617 Version 3)</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    
    <script src="/js/navigation.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    
    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}]});"></script>
    
    <script>
        
        if (window.feather) feather.replace();
    </script>
</body>
</html>
