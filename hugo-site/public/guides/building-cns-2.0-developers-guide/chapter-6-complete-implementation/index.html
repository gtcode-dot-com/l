<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chapter 6: Complete Implementation | Building CNS 2.0: A Developer&#39;s Guide</title>
    <meta name="description" content="Production-ready CNS 2.0 system with full synthesis capabilities and deployment guidelines">
    <meta name="author" content="CNS Development Team">
    
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">
    
    
    <link rel="stylesheet" href="/css/style.css?v=1753859298">
    
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    




    
    
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
    <div class="site-wrapper">
        
        <header class="site-header">
            <div class="container">
                <nav class="main-nav">
                    <div class="nav-brand">
                        <a href="/guides/building-cns-2.0-developers-guide/" class="brand-link">
                            <span class="brand-icon">üß†</span>
                            <span class="brand-text">Building CNS 2.0: A Developer&#39;s Guide</span>
                        </a>
                    </div>
                    
                    <div class="nav-menu">
                        <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
                            <i data-feather="menu"></i>
                        </button>
                        
                        <ul class="nav-list">
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-1-introduction/" class="nav-link ">
                                        Introduction
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-2-sno-foundations/" class="nav-link ">
                                        SNO Foundations
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-3-critic-pipeline/" class="nav-link ">
                                        Critic Pipeline
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-4-synthesis-engine/" class="nav-link ">
                                        Synthesis Engine
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-5-system-integration/" class="nav-link ">
                                        System Integration
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-6-complete-implementation/" class="nav-link ">
                                        Complete Implementation
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-7-dspy-integration/" class="nav-link ">
                                        DSPy Integration
                                    </a>
                                </li>
                            
                        </ul>
                    </div>
                </nav>
            </div>
        </header>

        
        <main class="site-main">
            <div class="container">
                
<article class="content-article">
    
    <header class="article-header">
        <div class="article-meta">
            <span class="article-weight">Chapter 6 of 7</span>
            <span class="article-separator">‚Ä¢</span>
            <time class="article-date">July 29, 2025</time>
        </div>
        
        <h1 class="article-title">Chapter 6: Complete Implementation</h1>
        
        
        <p class="article-description">Production-ready CNS 2.0 system with full synthesis capabilities and deployment guidelines</p>
        
        
        
        <div class="progress-indicator">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100.02000000000001%"></div>
            </div>
        </div>
    </header>

    
    <aside class="article-toc">
        <h3>Table of Contents</h3>
        <nav id="TableOfContents">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#bringing-it-all-together">Bringing It All Together</a></li>
    <li><a href="#complete-synthesis-implementation">Complete Synthesis Implementation</a>
      <ul>
        <li><a href="#from-paper-to-code-the-dialectical-prompt">From Paper to Code: The Dialectical Prompt</a></li>
      </ul>
    </li>
    <li><a href="#deployment-and-scaling-for-production">Deployment and Scaling for Production</a>
      <ul>
        <li><a href="#1-containerization-with-docker">1. Containerization with Docker</a></li>
        <li><a href="#2-scaling-with-a-dedicated-job-queue-celery">2. Scaling with a Dedicated Job Queue (Celery)</a></li>
        <li><a href="#3-production-ready-logging-with-structlog">3. Production-Ready Logging with <code>structlog</code></a></li>
        <li><a href="#3-production-configuration-management">3. Production Configuration Management</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </nav>
    </aside>

    
    <div class="article-content">
        <div class="guide-header">
    <a href="/" class="home-link">‚Üê Back to GTCode.com Homepage</a>
</div>
<h1 id="chapter-6-complete-implementation">Chapter 6: Complete Implementation</h1>
<h2 id="bringing-it-all-together">Bringing It All Together</h2>
<p>This chapter builds upon the functional primitives from previous chapters to create a fully integrated, end-to-end system. We will complete the implementation with a realistic synthesis engine and, most importantly, provide clear guidelines for deploying the CNS 2.0 system in a production environment.</p>
<h2 id="complete-synthesis-implementation">Complete Synthesis Implementation</h2>
<p>To make our implementation more realistic, we&rsquo;ll replace the hardcoded synthesis outputs with a <code>MockLLMClient</code>. This simulates the asynchronous nature of a real API call and makes the code structure identical to a production version, ready to be swapped with a real client like <code>OpenAI</code> or <code>Anthropic</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Complete CNS 2.0 Synthesis Implementation
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">=======================================
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Production-ready synthesis engine with a mock LLM client and deployment guidelines.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, List, Optional, Any, Tuple
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dataclasses <span style="color:#f92672">import</span> dataclass
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MockLLMClient</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;A mock client to simulate asynchronous LLM API calls.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">complete</span>(self, prompt: str, strategy: SynthesisStrategy) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1.5</span>) <span style="color:#75715e"># Simulate network latency</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;MockLLMClient: Received prompt for </span><span style="color:#e6db74">{</span>strategy<span style="color:#f92672">.</span>value<span style="color:#e6db74">}</span><span style="color:#e6db74"> strategy.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        synthesis_outputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            SynthesisStrategy<span style="color:#f92672">.</span>DIALECTICAL: <span style="color:#e6db74">&#34;The apparent contradiction is resolved by recognizing that both perspectives address different temporal dimensions of the phenomenon, suggesting a more nuanced, context-dependent understanding.&#34;</span>,
</span></span><span style="display:flex;"><span>            SynthesisStrategy<span style="color:#f92672">.</span>COMPLEMENTARY: <span style="color:#e6db74">&#34;Both narratives contribute essential insights that, when integrated, provide a more comprehensive understanding of the phenomenon.&#34;</span>,
</span></span><span style="display:flex;"><span>            SynthesisStrategy<span style="color:#f92672">.</span>TRANSCENDENT: <span style="color:#e6db74">&#34;A higher-order perspective reveals that both narratives are special cases of a more general underlying principle.&#34;</span>,
</span></span><span style="display:flex;"><span>            SynthesisStrategy<span style="color:#f92672">.</span>EVIDENTIAL: <span style="color:#e6db74">&#34;Re-analysis of the shared evidence indicates that different methodological assumptions led to the divergent conclusions, which can be reconciled.&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> synthesis_outputs<span style="color:#f92672">.</span>get(strategy, <span style="color:#e6db74">&#34;A new synthesized hypothesis has been generated.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SynthesisResult</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ... (definition as before)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AdvancedSynthesisEngine</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Complete synthesis engine implementing all CNS 2.0 synthesis strategies.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This version uses a more realistic client-based approach for LLM interaction.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, critic_pipeline: CriticPipeline, llm_client: Any):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>critic_pipeline <span style="color:#f92672">=</span> critic_pipeline
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>llm_client <span style="color:#f92672">=</span> llm_client <span style="color:#75715e"># Use a client for LLM calls</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>synthesis_history: List[SynthesisResult] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>generation_templates <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_load_synthesis_templates()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>synthesis_stats <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;total_attempts&#39;</span>: <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;successful_syntheses&#39;</span>: <span style="color:#ae81ff">0</span>}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_load_synthesis_templates</span>(self) <span style="color:#f92672">-&gt;</span> Dict[SynthesisStrategy, str]:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Templates remain the same, providing structured prompts for the LLM</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ... (template dictionary as before)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_generate_synthesis_hypothesis</span>(self, prompt: str, strategy: SynthesisStrategy) <span style="color:#f92672">-&gt;</span> Optional[str]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generates a synthesis hypothesis by making an asynchronous call to the LLM client.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            response_text <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>llm_client<span style="color:#f92672">.</span>complete(prompt<span style="color:#f92672">=</span>prompt, strategy<span style="color:#f92672">=</span>strategy)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> response_text<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;LLM generation failed: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_determine_synthesis_strategy</span>(self, chiral_pair: ChiralPair) <span style="color:#f92672">-&gt;</span> SynthesisStrategy:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Logic for determining strategy remains the same</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ... (implementation as before)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_construct_synthesis_prompt</span>(self, chiral_pair: ChiralPair, strategy: SynthesisStrategy) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Logic for building the prompt from SNOs remains the same</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ... (implementation as before)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">synthesize_chiral_pair</span>(self, chiral_pair: ChiralPair) <span style="color:#f92672">-&gt;</span> SynthesisResult:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Complete synthesis of a chiral pair using the most appropriate strategy.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        This method orchestrates the entire synthesis process.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>synthesis_stats[<span style="color:#e6db74">&#39;total_attempts&#39;</span>] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 1. Determine strategy, construct prompt, and generate hypothesis</span>
</span></span><span style="display:flex;"><span>        strategy <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_determine_synthesis_strategy(chiral_pair)
</span></span><span style="display:flex;"><span>        prompt <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_construct_synthesis_prompt(chiral_pair, strategy)
</span></span><span style="display:flex;"><span>        candidate_hypothesis <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_generate_synthesis_hypothesis(prompt, strategy)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> candidate_hypothesis:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Handle generation failure</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_create_failed_result(chiral_pair, strategy, <span style="color:#e6db74">&#34;Failed to generate hypothesis from LLM.&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 2. Create and evaluate the new SNO</span>
</span></span><span style="display:flex;"><span>        synthesized_sno <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_create_synthesized_sno(candidate_hypothesis, chiral_pair)
</span></span><span style="display:flex;"><span>        evaluation_result <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>critic_pipeline<span style="color:#f92672">.</span>evaluate_sno(
</span></span><span style="display:flex;"><span>            synthesized_sno,
</span></span><span style="display:flex;"><span>            {<span style="color:#e6db74">&#39;sno_population&#39;</span>: [chiral_pair<span style="color:#f92672">.</span>sno_a, chiral_pair<span style="color:#f92672">.</span>sno_b]}
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 3. Validate and finalize the result</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> synthesized_sno<span style="color:#f92672">.</span>trust_score <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0.5</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_create_failed_result(chiral_pair, strategy, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Low quality synthesis: </span><span style="color:#e6db74">{</span>synthesized_sno<span style="color:#f92672">.</span>trust_score<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ... (Create successful SynthesisResult object as before) ...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ... (Other helper methods like _create_synthesized_sno, _create_failed_result, etc. remain the same) ...</span>
</span></span></code></pre></div><h3 id="from-paper-to-code-the-dialectical-prompt">From Paper to Code: The Dialectical Prompt</h3>
<p>(This section remains the same as the original file.)</p>
<h2 id="deployment-and-scaling-for-production">Deployment and Scaling for Production</h2>
<p>A &ldquo;complete&rdquo; implementation isn&rsquo;t just about code; it&rsquo;s about making that code deployable, scalable, and observable. The <code>asyncio</code>-based system we&rsquo;ve built is an excellent single-process application, but a production-grade system requires a more robust, distributed architecture. This section provides a step-by-step guide to productionizing the CNS 2.0 system.</p>
<h3 id="1-containerization-with-docker">1. Containerization with Docker</h3>
<p>Containerizing the CNS system with Docker is the first step. It provides a consistent, isolated, and portable environment, which is critical for reliable deployment.</p>
<p><strong>Step 1: Create a <code>requirements.txt</code> file.</strong>
This file lists all Python dependencies for your project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span># requirements.txt
</span></span><span style="display:flex;"><span>numpy
</span></span><span style="display:flex;"><span>networkx
</span></span><span style="display:flex;"><span>torch
</span></span><span style="display:flex;"><span>transformers
</span></span><span style="display:flex;"><span>sentence-transformers
</span></span><span style="display:flex;"><span>faiss-cpu         # Use faiss-gpu if you have a compatible GPU
</span></span><span style="display:flex;"><span>scikit-learn
</span></span><span style="display:flex;"><span>matplotlib
</span></span><span style="display:flex;"><span>PyYAML            # For loading config files from YAML
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># For a production job queue
</span></span><span style="display:flex;"><span>redis
</span></span><span style="display:flex;"><span>celery
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># For structured logging
</span></span><span style="display:flex;"><span>structlog
</span></span></code></pre></div><p><strong>Step 2: Create a <code>Dockerfile</code>.</strong>
This file is a blueprint for building your container image.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># Start with an official Python slim image for a smaller footprint</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.10-slim</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Set the working directory inside the container</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /usr/src/app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy the requirements file first to leverage Docker&#39;s layer caching.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Dependencies will only be re-installed if this file changes.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> requirements.txt ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install --no-cache-dir -r requirements.txt<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy the rest of the application code into the container.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># This is done *after* installing dependencies, so code changes</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># don&#39;t trigger a full dependency re-installation.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Define the default command to run when the container starts.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># This will typically be the command to start a Celery worker.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [ <span style="color:#e6db74">&#34;celery&#34;</span>, <span style="color:#e6db74">&#34;-A&#34;</span>, <span style="color:#e6db74">&#34;cns.tasks&#34;</span>, <span style="color:#e6db74">&#34;worker&#34;</span>, <span style="color:#e6db74">&#34;--loglevel=info&#34;</span> ]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><strong>Step 3: Build the Docker image.</strong>
From your terminal, run the build command:
<code>docker build -t cns-worker:latest .</code></p>
<p>With this image, you can now run the CNS system anywhere Docker is installed, eliminating &ldquo;it works on my machine&rdquo; problems.</p>
<h3 id="2-scaling-with-a-dedicated-job-queue-celery">2. Scaling with a Dedicated Job Queue (Celery)</h3>
<p>The in-memory <code>asyncio.Queue</code> is a major bottleneck for scaling. A production environment with multiple workers requires a centralized <strong>message broker</strong> to distribute tasks. We will use <strong>Celery</strong> with <strong>Redis</strong>.</p>
<p>The architecture shifts as follows:</p>
<ol>
<li><strong>API Server (e.g., FastAPI)</strong>: A lightweight web server receives requests (e.g., to ingest a new document). Instead of processing it directly, it enqueues a task in Celery.</li>
<li><strong>Message Broker (Redis)</strong>: Redis holds the queue of tasks to be processed. It is a fast, in-memory data store that is perfect for this role.</li>
<li><strong>Celery Workers (Multiple Docker Containers)</strong>: These are the workhorses. You can run multiple instances of your <code>cns-worker</code> container. Each worker pulls a task from the Redis queue and executes it.</li>
</ol>
<p><strong>Step 1: Define Celery tasks.</strong>
Create a <code>tasks.py</code> file. This is where you define the functions that your workers will execute.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># cns/tasks.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> .workflow <span style="color:#f92672">import</span> CNSWorkflowManager <span style="color:#75715e"># Your main CNS logic</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> .logging_setup <span style="color:#f92672">import</span> logger <span style="color:#75715e"># Use our structured logger</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configure Celery to use Redis as the message broker.</span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;cns_tasks&#39;</span>, broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://redis:6379/0&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize a singleton instance of the CNS manager.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Models are loaded only once per worker process, which is very efficient.</span>
</span></span><span style="display:flex;"><span>cns_manager <span style="color:#f92672">=</span> CNSWorkflowManager()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.task</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ingestion</span>(document_text: str, source: str):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;A Celery task to handle the ingestion of a single document.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;ingestion_task_received&#34;</span>, source<span style="color:#f92672">=</span>source)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Note: The original manager used asyncio. For Celery, you would</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># adapt the core logic to be synchronous or use Celery&#39;s async support.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Here, we assume a synchronous `ingest_and_evaluate` method.</span>
</span></span><span style="display:flex;"><span>    cns_manager<span style="color:#f92672">.</span>ingest_and_evaluate(document_text, source)
</span></span><span style="display:flex;"><span>    logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;ingestion_task_complete&#34;</span>, source<span style="color:#f92672">=</span>source)
</span></span></code></pre></div><p><strong>Step 2: Start the services.</strong>
You would typically use <code>docker-compose</code> to start Redis, the API server, and your Celery workers together. This architecture decouples task submission from processing, allowing you to scale the number of workers independently to handle any workload.</p>
<h3 id="3-production-ready-logging-with-structlog">3. Production-Ready Logging with <code>structlog</code></h3>
<p>In a distributed system with multiple workers, standard print statements or basic logs are insufficient. You need <strong>structured logging</strong>. Structured logs (e.g., in JSON format) are machine-readable, making them easy to search, filter, and analyze in a centralized logging platform (like ELK Stack, Splunk, or Datadog).</p>
<p><strong>Step 1: Configure <code>structlog</code>.</strong>
Create a <code>logging_setup.py</code> file to configure logging for your entire application.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># cns/logging_setup.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> structlog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configure standard logging</span>
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>basicConfig(level<span style="color:#f92672">=</span>logging<span style="color:#f92672">.</span>INFO)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configure structlog</span>
</span></span><span style="display:flex;"><span>structlog<span style="color:#f92672">.</span>configure(
</span></span><span style="display:flex;"><span>    processors<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>        structlog<span style="color:#f92672">.</span>stdlib<span style="color:#f92672">.</span>add_log_level,
</span></span><span style="display:flex;"><span>        structlog<span style="color:#f92672">.</span>processors<span style="color:#f92672">.</span>TimeStamper(fmt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;iso&#34;</span>),
</span></span><span style="display:flex;"><span>        structlog<span style="color:#f92672">.</span>processors<span style="color:#f92672">.</span>JSONRenderer(),
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    logger_factory<span style="color:#f92672">=</span>structlog<span style="color:#f92672">.</span>stdlib<span style="color:#f92672">.</span>LoggerFactory(),
</span></span><span style="display:flex;"><span>    wrapper_class<span style="color:#f92672">=</span>structlog<span style="color:#f92672">.</span>stdlib<span style="color:#f92672">.</span>BoundLogger,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> structlog<span style="color:#f92672">.</span>get_logger()
</span></span></code></pre></div><p><strong>Step 2: Use the logger in your application.</strong>
Instead of <code>print()</code> or <code>logging.info()</code>, use the <code>structlog</code> logger.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># in cns/workflow.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> .logging_setup <span style="color:#f92672">import</span> logger
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CNSWorkflowManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ingest_and_evaluate</span>(self, text, source):
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;sno_ingestion_started&#34;</span>, source<span style="color:#f92672">=</span>source, text_length<span style="color:#f92672">=</span>len(text))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># ... ingestion logic ...</span>
</span></span><span style="display:flex;"><span>            sno <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ingestion_pipeline<span style="color:#f92672">.</span>ingest_document(text, source)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># ... evaluation logic ...</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>critic_pipeline<span style="color:#f92672">.</span>evaluate_sno(sno, context)
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>info(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;sno_evaluation_complete&#34;</span>,
</span></span><span style="display:flex;"><span>                sno_id<span style="color:#f92672">=</span>sno<span style="color:#f92672">.</span>sno_id,
</span></span><span style="display:flex;"><span>                trust_score<span style="color:#f92672">=</span>sno<span style="color:#f92672">.</span>trust_score,
</span></span><span style="display:flex;"><span>                source<span style="color:#f92672">=</span>source,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;ingestion_failed&#34;</span>, error<span style="color:#f92672">=</span>str(e), source<span style="color:#f92672">=</span>source)
</span></span></code></pre></div><p>When this code runs, it will produce JSON log entries like this:
<code>{&quot;log_level&quot;: &quot;info&quot;, &quot;timestamp&quot;: &quot;2023-10-27T10:30:00Z&quot;, &quot;event&quot;: &quot;sno_evaluation_complete&quot;, &quot;sno_id&quot;: &quot;...&quot;, &quot;trust_score&quot;: 0.75, &quot;source&quot;: &quot;doc1.pdf&quot;}</code></p>
<p>This format is incredibly powerful for debugging and monitoring a complex, distributed system.</p>
<h3 id="3-production-configuration-management">3. Production Configuration Management</h3>
<p>In our guide, we&rsquo;ve used a <code>CNSConfig</code> class with hardcoded values for simplicity. This is not suitable for a production environment where you need to change parameters without altering the code. The solution is to externalize the configuration.</p>
<h4 id="strategy-1-environment-variables">Strategy 1: Environment Variables</h4>
<p>A common practice is to read configuration from environment variables. This is highly portable and aligns with the principles of <a href="https://12factor.net/config">12-factor apps</a>.</p>
<p>You would modify the <code>CNSConfig</code> class to read from <code>os.environ</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CNSConfig</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Read from environment variable, falling back to a default value.</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>embedding_dim <span style="color:#f92672">=</span> int(os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;CNS_EMBEDDING_DIM&#39;</span>, <span style="color:#ae81ff">768</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># For nested structures, we can expect a JSON string.</span>
</span></span><span style="display:flex;"><span>        default_weights <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{&#34;grounding&#34;: 0.4, &#34;logic&#34;: 0.3, &#34;novelty&#34;: 0.3}&#39;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>critic_weights <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;CNS_CRITIC_WEIGHTS&#39;</span>, default_weights))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ... and so on for all other parameters.</span>
</span></span></code></pre></div><p>When running in Docker, you can pass these environment variables using the <code>-e</code> flag:
<code>docker run -e CNS_CRITIC_WEIGHTS='{&quot;grounding&quot;: 0.8, &quot;logic&quot;: 0.1, &quot;novelty&quot;: 0.1}' cns-app</code></p>
<h4 id="strategy-2-configuration-file">Strategy 2: Configuration File</h4>
<p>For more complex configurations, a dedicated file is often easier to manage. Since we saw a <code>config.yaml</code> in the repository, let&rsquo;s use that.</p>
<p>First, create a <code>config.yaml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># config.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">embedding_dim</span>: <span style="color:#ae81ff">768</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">critic_weights</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">grounding</span>: <span style="color:#ae81ff">0.4</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">logic</span>: <span style="color:#ae81ff">0.3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">novelty</span>: <span style="color:#ae81ff">0.3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">models</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">embedding</span>: <span style="color:#e6db74">&#34;all-MiniLM-L6-v2&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nli</span>: <span style="color:#e6db74">&#34;roberta-large-mnli&#34;</span>
</span></span></code></pre></div><p>Then, modify <code>CNSConfig</code> to load from this file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CNSConfig</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, config_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;config.yaml&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(config_path, <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>            config <span style="color:#f92672">=</span> yaml<span style="color:#f92672">.</span>safe_load(f)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>embedding_dim <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#39;embedding_dim&#39;</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>critic_weights <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#39;critic_weights&#39;</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>models <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#39;models&#39;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ... and so on</span>
</span></span></code></pre></div><p>This approach makes it easy to maintain multiple configuration profiles (e.g., <code>config_dev.yaml</code>, <code>config_prod.yaml</code>) and provides a clear, version-controllable record of the system&rsquo;s parameters.</p>

    </div>

    
    <nav class="article-nav">
        <div class="nav-previous">
            
                <a href="/guides/building-cns-2.0-developers-guide/chapter-7-dspy-integration/" class="nav-link prev-link">
                    <i data-feather="arrow-right"></i>
                    <div class="nav-text">
                        <span class="nav-label">Next</span>
                        <span class="nav-title">Chapter 7: Advanced Optimization with DSPy</span>
                    </div>
                </a>
            
        </div>
        
        <div class="nav-next">
            
                <a href="/guides/building-cns-2.0-developers-guide/chapter-5-system-integration/" class="nav-link next-link">
                    <div class="nav-text">
                        <span class="nav-label">Previous</span>
                        <span class="nav-title">Chapter 5: System Integration</span>
                    </div>
                    <i data-feather="arrow-left"></i>
                </a>
            
        </div>
    </nav>

    
    <aside class="chapter-summary">
        <h3>Chapter Summary</h3>
        <div class="summary-content">
            
                <p>Complete production-ready implementation with deployment guidelines.</p>
                <ul>
                    <li>Advanced synthesis engine</li>
                    <li>Production deployment configuration</li>
                    <li>Performance optimization and monitoring</li>
                </ul>
            
        </div>
    </aside>
</article>

            </div>
        </main>

        
        <footer class="site-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-text">
                        <p>&copy; 2025 <a href="https://GTCode.com/" class="footer-link">GTCode.com</a>. Educational content for CNS 2.0 implementation.</p>
                        <p>Based on <a target="_blank" 
                               rel="noopener noreferrer" href="/papers/ResearchProposal-ChiralNarrativeSynthesis_20250617_3.pdf" class="footer-link">CNS 2.0: A Practical Blueprint for Chiral Narrative Synthesis</a> research paper. (20250617 Version 3)</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    
    <script src="/js/navigation.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    
    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}]});"></script>
    
    <script>
        
        if (window.feather) feather.replace();
    </script>
</body>
</html>
