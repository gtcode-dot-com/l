<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chapter 5: System Integration | Building CNS 2.0: A Developer&#39;s Guide</title>
    <meta name="description" content="Combining all CNS 2.0 components into a working system with workflow management">
    <meta name="author" content="CNS Development Team">
    
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">
    
    
    <link rel="stylesheet" href="/css/style.css?v=1753859163">
    
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    




    
    
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
    <div class="site-wrapper">
        
        <header class="site-header">
            <div class="container">
                <nav class="main-nav">
                    <div class="nav-brand">
                        <a href="/guides/building-cns-2.0-developers-guide/" class="brand-link">
                            <span class="brand-icon">üß†</span>
                            <span class="brand-text">Building CNS 2.0: A Developer&#39;s Guide</span>
                        </a>
                    </div>
                    
                    <div class="nav-menu">
                        <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
                            <i data-feather="menu"></i>
                        </button>
                        
                        <ul class="nav-list">
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-1-introduction/" class="nav-link ">
                                        Introduction
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-2-sno-foundations/" class="nav-link ">
                                        SNO Foundations
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-3-critic-pipeline/" class="nav-link ">
                                        Critic Pipeline
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-4-synthesis-engine/" class="nav-link ">
                                        Synthesis Engine
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-5-system-integration/" class="nav-link ">
                                        System Integration
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-6-complete-implementation/" class="nav-link ">
                                        Complete Implementation
                                    </a>
                                </li>
                            
                                <li class="nav-item">
                                    <a href="/guides/building-cns-2.0-developers-guide/chapter-7-dspy-integration/" class="nav-link ">
                                        DSPy Integration
                                    </a>
                                </li>
                            
                        </ul>
                    </div>
                </nav>
            </div>
        </header>

        
        <main class="site-main">
            <div class="container">
                
<article class="content-article">
    
    <header class="article-header">
        <div class="article-meta">
            <span class="article-weight">Chapter 5 of 7</span>
            <span class="article-separator">‚Ä¢</span>
            <time class="article-date">July 29, 2025</time>
        </div>
        
        <h1 class="article-title">Chapter 5: System Integration</h1>
        
        
        <p class="article-description">Combining all CNS 2.0 components into a working system with workflow management</p>
        
        
        
        <div class="progress-indicator">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 83.35000000000001%"></div>
            </div>
        </div>
    </header>

    
    <aside class="article-toc">
        <h3>Table of Contents</h3>
        <nav id="TableOfContents">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#building-the-complete-cns-20-system">Building the Complete CNS 2.0 System</a></li>
    <li><a href="#system-architecture-with-persistence">System Architecture with Persistence</a></li>
    <li><a href="#production-grade-persistence-from-json-to-a-database">Production-Grade Persistence: From JSON to a Database</a>
      <ul>
        <li><a href="#the-limitations-of-file-based-persistence">The Limitations of File-Based Persistence</a></li>
        <li><a href="#solution-1-adopting-a-document-database-eg-mongodb">Solution 1: Adopting a Document Database (e.g., MongoDB)</a></li>
        <li><a href="#solution-2-managing-schema-evolution">Solution 2: Managing Schema Evolution</a></li>
      </ul>
    </li>
    <li><a href="#monitoring-the-health-of-the-cns-system">Monitoring the Health of the CNS System</a>
      <ul>
        <li><a href="#system-performance-metrics">System Performance Metrics</a></li>
        <li><a href="#knowledge-quality-and-dynamics-metrics">Knowledge Quality and Dynamics Metrics</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </nav>
    </aside>

    
    <div class="article-content">
        <div class="guide-header">
    <a href="/" class="home-link">‚Üê Back to GTCode.com Homepage</a>
</div>
<h1 id="chapter-5-system-integration">Chapter 5: System Integration</h1>
<h2 id="building-the-complete-cns-20-system">Building the Complete CNS 2.0 System</h2>
<p>Now that we&rsquo;ve implemented the core components, it&rsquo;s time to integrate them into a cohesive system. This chapter focuses on the operational workflow, system dynamics, and the critical narrative ingestion pipeline. The result will be a stateful, autonomous system capable of running continuously.</p>
<h2 id="system-architecture-with-persistence">System Architecture with Persistence</h2>
<p>A key enhancement in this chapter is adding <strong>persistence</strong>. An autonomous system that runs for long periods must be able to save its state and resume after a shutdown. We will add methods to save the entire SNO population and system metrics to a file, making our workflow manager robust.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CNS 2.0 System Integration with Persistence
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">===========================================
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Complete system architecture that can save and load its state.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, List, Optional, Any
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dataclasses <span style="color:#f92672">import</span> dataclass, field
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime, timedelta
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> queue <span style="color:#f92672">import</span> PriorityQueue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ... (Assume other classes like SystemMetrics are defined) ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For an async system, we use asyncio&#39;s Queue</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> Queue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CNSWorkflowManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Manages the complete CNS 2.0 operational workflow with state persistence.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This version includes the full asynchronous processing loop.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, state_file: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cns_system_state.json&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Core components</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>sno_population: List[StructuredNarrativeObject] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>critic_pipeline <span style="color:#f92672">=</span> CriticPipeline()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>synthesis_engine <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span> <span style="color:#75715e"># Will be initialized after models are loaded</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ML Models</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>embedding_model <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>nli_model <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>nli_tokenizer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># System state and control</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>is_running <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>task_queue <span style="color:#f92672">=</span> Queue() <span style="color:#75715e"># Use asyncio&#39;s Queue for async operations</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>metrics <span style="color:#f92672">=</span> SystemMetrics()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>start_time <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>now()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state_file <span style="color:#f92672">=</span> state_file
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_load_models_and_components()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_load_system_state()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_load_models_and_components</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Loads all necessary ML models and initializes components that depend on them.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Loading ML models and initializing components...&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> HAS_TRANSFORMERS:
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;Transformers library not available. Cannot run research-grade system.&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">from</span> sentence_transformers <span style="color:#f92672">import</span> SentenceTransformer
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">import</span> transformers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Load models</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>embedding_model <span style="color:#f92672">=</span> SentenceTransformer(cns_config<span style="color:#f92672">.</span>models[<span style="color:#e6db74">&#39;embedding&#39;</span>])
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>nli_tokenizer <span style="color:#f92672">=</span> transformers<span style="color:#f92672">.</span>AutoTokenizer<span style="color:#f92672">.</span>from_pretrained(cns_config<span style="color:#f92672">.</span>models[<span style="color:#e6db74">&#39;nli&#39;</span>])
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>nli_model <span style="color:#f92672">=</span> transformers<span style="color:#f92672">.</span>AutoModelForSequenceClassification<span style="color:#f92672">.</span>from_pretrained(cns_config<span style="color:#f92672">.</span>models[<span style="color:#e6db74">&#39;nli&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize components that require models</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ingestion_pipeline <span style="color:#f92672">=</span> NarrativeIngestionPipeline(self<span style="color:#f92672">.</span>embedding_model)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chiral_detector <span style="color:#f92672">=</span> ChiralPairDetector(embedding_model<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>embedding_model)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_initialize_critics()
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># self.synthesis_engine = AdvancedSynthesisEngine(...) # Assume this is initialized</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;All models and components loaded successfully.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_initialize_critics</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ... (implementation is the same as before) ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">### --- The Asynchronous Main Loop --- ###</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;The main entry point to start the continuous operation of the CNS system.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>is_running <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;CNS Workflow Manager is running...&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create a background task for processing the queue</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>processing_task <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(self<span style="color:#f92672">.</span>_process_task_queue())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Keep the main loop alive (e.g., to handle API requests or other inputs)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>is_running:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># On shutdown, ensure the processing task is cancelled</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>processing_task<span style="color:#f92672">.</span>cancel()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>shutdown_system()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_process_task_queue</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Continuously fetches tasks from the queue and handles them.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>is_running:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                task <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>task_queue<span style="color:#f92672">.</span>get()
</span></span><span style="display:flex;"><span>                task_type, data <span style="color:#f92672">=</span> task
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> task_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;ingest&#34;</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_handle_ingestion_task(data)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">elif</span> task_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;evaluate&#34;</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_handle_evaluation_task(data)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">elif</span> task_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;synthesize&#34;</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_handle_synthesis_task()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>task_queue<span style="color:#f92672">.</span>task_done()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> asyncio<span style="color:#f92672">.</span>CancelledError:
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Task processing loop cancelled.&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error in task processing loop: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_handle_ingestion_task</span>(self, data):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Processes a document ingestion task.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Ingesting document: </span><span style="color:#e6db74">{</span>data[<span style="color:#e6db74">&#39;source&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        sno <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ingestion_pipeline<span style="color:#f92672">.</span>ingest_document(data[<span style="color:#e6db74">&#39;text&#39;</span>], data[<span style="color:#e6db74">&#39;source&#39;</span>])
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>sno_population<span style="color:#f92672">.</span>append(sno)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>metrics<span style="color:#f92672">.</span>sno_ingested()
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># New SNOs should be evaluated</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>task_queue<span style="color:#f92672">.</span>put((<span style="color:#e6db74">&#34;evaluate&#34;</span>, sno))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_handle_evaluation_task</span>(self, sno: StructuredNarrativeObject):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Processes an SNO evaluation task.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Evaluating SNO: </span><span style="color:#e6db74">{</span>sno<span style="color:#f92672">.</span>sno_id[:<span style="color:#ae81ff">8</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        context <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;sno_population&#39;</span>: self<span style="color:#f92672">.</span>sno_population}
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>critic_pipeline<span style="color:#f92672">.</span>evaluate_sno(sno, context)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>metrics<span style="color:#f92672">.</span>sno_evaluated()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># After evaluation, check if synthesis should be triggered</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(self<span style="color:#f92672">.</span>sno_population) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>task_queue<span style="color:#f92672">.</span>put((<span style="color:#e6db74">&#34;synthesize&#34;</span>, <span style="color:#66d9ef">None</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_handle_synthesis_task</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Finds chiral pairs and synthesizes a new SNO if conditions are met.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Checking for synthesis opportunities...&#34;</span>)
</span></span><span style="display:flex;"><span>        chiral_pairs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>chiral_detector<span style="color:#f92672">.</span>find_chiral_pairs(self<span style="color:#f92672">.</span>sno_population)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> chiral_pairs:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># For simplicity, we&#39;ll try to synthesize the top pair</span>
</span></span><span style="display:flex;"><span>            top_pair <span style="color:#f92672">=</span> chiral_pairs[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Synthesizing new SNO from pair: </span><span style="color:#e6db74">{</span>top_pair<span style="color:#f92672">.</span>sno_a<span style="color:#f92672">.</span>sno_id[:<span style="color:#ae81ff">8</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74"> and </span><span style="color:#e6db74">{</span>top_pair<span style="color:#f92672">.</span>sno_b<span style="color:#f92672">.</span>sno_id[:<span style="color:#ae81ff">8</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># result = await self.synthesis_engine.synthesize_chiral_pair(top_pair)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># if result.success:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#     self.sno_population.append(result.synthesized_sno)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#     self.metrics.sno_synthesized()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#     await self.task_queue.put((&#34;evaluate&#34;, result.synthesized_sno))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;No suitable pairs found for synthesis.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">### --- Persistence and Shutdown --- ###</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">shutdown_system</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Gracefully shuts down the CNS 2.0 system and saves state.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>is_running <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;CNS 2.0 System shutting down...&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_save_system_state()
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;System shutdown complete.&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_save_system_state</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ... (implementation is the same as before) ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_load_system_state</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ... (implementation is the same as before) ...</span>
</span></span></code></pre></div><h2 id="production-grade-persistence-from-json-to-a-database">Production-Grade Persistence: From JSON to a Database</h2>
<p>An autonomous knowledge synthesis system is designed for long-running tasks, making robust data persistence a non-negotiable requirement. While the <code>_save_system_state</code> and <code>_load_system_state</code> methods using a single JSON file are a good starting point for development, a production system requires a more scalable and robust solution. This section provides a guide to upgrading the persistence layer.</p>
<h3 id="the-limitations-of-file-based-persistence">The Limitations of File-Based Persistence</h3>
<ul>
<li><strong>Performance &amp; Scalability</strong>: As the SNO population grows, the <code>cns_system_state.json</code> file can become enormous. Loading and parsing a multi-gigabyte JSON file on every startup is unacceptably slow.</li>
<li><strong>Concurrency</strong>: A single file cannot be safely written to by multiple processes or workers simultaneously, which is essential for a scaled-out system. This creates a major bottleneck.</li>
<li><strong>Querying</strong>: Answering simple questions like &ldquo;Find all SNOs with a trust score above 0.8&rdquo; requires loading and scanning the entire file, which is grossly inefficient.</li>
</ul>
<h3 id="solution-1-adopting-a-document-database-eg-mongodb">Solution 1: Adopting a Document Database (e.g., MongoDB)</h3>
<p>A <strong>document database</strong> is the ideal solution for storing SNOs, as the JSON-like dictionary from <code>sno.to_dict()</code> maps directly to a document structure.</p>
<p><strong>Conceptual Implementation:</strong></p>
<ol>
<li><strong>Setup</strong>: Install a database client library (e.g., <code>pip install pymongo</code>).</li>
<li><strong>Connection</strong>: Your <code>CNSWorkflowManager</code> should establish a connection to your database server.</li>
<li><strong>Data Operations</strong>: Replace file I/O with database operations. The <code>sno_id</code> can serve as the unique <code>_id</code> for documents.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Conceptual example of saving an SNO to MongoDB</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pymongo <span style="color:#f92672">import</span> MongoClient, ReplaceOne
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># client = MongoClient(&#39;mongodb://your-mongo-uri/&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># db = client.cns_database</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sno_collection = db.sno_population</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_sno_to_db</span>(sno: StructuredNarrativeObject):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Saves a single SNO, inserting or updating as needed.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    sno_dict <span style="color:#f92672">=</span> sno<span style="color:#f92672">.</span>to_dict()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Use update_one with upsert=True for an efficient insert-or-update operation.</span>
</span></span><span style="display:flex;"><span>    sno_collection<span style="color:#f92672">.</span>update_one(
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#39;_id&#39;</span>: sno<span style="color:#f92672">.</span>sno_id},
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#39;$set&#39;</span>: sno_dict},
</span></span><span style="display:flex;"><span>        upsert<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><p>This approach provides <strong>indexed queries</strong> (e.g., <code>db.sno_population.find({'trust_score': {'$gt': 0.8}})</code>), massive <strong>scalability</strong>, and safe <strong>concurrent access</strong>.</p>
<h3 id="solution-2-managing-schema-evolution">Solution 2: Managing Schema Evolution</h3>
<p>As your system evolves, your <code>StructuredNarrativeObject</code> class will change. This is <strong>schema evolution</strong>. If you deploy new code, it will likely crash when it encounters old data. A robust system must handle this gracefully.</p>
<p>The solution, as introduced in Chapter 2, is <strong>schema versioning and migration</strong>.</p>
<ol>
<li><strong>Version your SNOs</strong>: Add a version field to your class, e.g., <code>sno_schema_version: int = 2</code>. Increment this when you make a breaking change.</li>
<li><strong>Implement a Migration Path</strong>: Your data loading logic must be able to handle old versions.</li>
</ol>
<p>Here is a more robust conceptual example of a data access function that handles migration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_sno_from_db</span>(sno_id: str) <span style="color:#f92672">-&gt;</span> Optional[StructuredNarrativeObject]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Loads a single SNO from the DB and applies necessary data migrations.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    sno_data <span style="color:#f92672">=</span> sno_collection<span style="color:#f92672">.</span>find_one({<span style="color:#e6db74">&#39;_id&#39;</span>: sno_id})
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> sno_data:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    schema_version <span style="color:#f92672">=</span> sno_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;sno_schema_version&#39;</span>, <span style="color:#ae81ff">1</span>) <span style="color:#75715e"># Assume legacy data is v1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Apply migrations sequentially to bring the data to the current version.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> schema_version <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Migration for v2: &#39;author&#39; field was added to metadata.</span>
</span></span><span style="display:flex;"><span>        sno_data[<span style="color:#e6db74">&#39;metadata&#39;</span>][<span style="color:#e6db74">&#39;author&#39;</span>] <span style="color:#f92672">=</span> sno_data[<span style="color:#e6db74">&#39;metadata&#39;</span>]<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;author&#39;</span>, <span style="color:#e6db74">&#39;Unknown&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> schema_version <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Migration for v3: &#39;claim_type&#39; was renamed to &#39;node_type&#39; in ClaimNode.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> node <span style="color:#f92672">in</span> sno_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;reasoning_graph&#39;</span>, {})<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;nodes&#39;</span>, []):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;claim&#39;</span> <span style="color:#f92672">in</span> node <span style="color:#f92672">and</span> <span style="color:#e6db74">&#39;claim_type&#39;</span> <span style="color:#f92672">in</span> node[<span style="color:#e6db74">&#39;claim&#39;</span>]:
</span></span><span style="display:flex;"><span>                node[<span style="color:#e6db74">&#39;claim&#39;</span>][<span style="color:#e6db74">&#39;node_type&#39;</span>] <span style="color:#f92672">=</span> node[<span style="color:#e6db74">&#39;claim&#39;</span>]<span style="color:#f92672">.</span>pop(<span style="color:#e6db74">&#39;claim_type&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># After migration, the data dictionary conforms to the latest schema.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> StructuredNarrativeObject<span style="color:#f92672">.</span>from_dict(sno_data)
</span></span></code></pre></div><p>By explicitly handling data migrations, you ensure your system can evolve without breaking compatibility with its own historical data‚Äîa hallmark of a production-ready application.</p>
<h2 id="monitoring-the-health-of-the-cns-system">Monitoring the Health of the CNS System</h2>
<p>An autonomous system like CNS 2.0 should not be a &ldquo;black box&rdquo; once deployed. Continuous monitoring is essential to ensure it is operating correctly, performing efficiently, and producing high-quality knowledge. A monitoring dashboard (e.g., using tools like Grafana, Prometheus, or Datadog) should track the following key metrics:</p>
<h3 id="system-performance-metrics">System Performance Metrics</h3>
<ul>
<li><strong>Task Queue Size</strong>: The number of pending tasks in the queue. A constantly growing queue indicates that the processing workers cannot keep up with the ingestion rate and that you may need to scale up your resources.</li>
<li><strong>Task Processing Latency</strong>: The average time it takes to process a single task (e.g., ingest a document, evaluate an SNO). Spikes in latency can indicate performance bottlenecks.</li>
<li><strong>Model API Latency &amp; Error Rate</strong>: If using external model APIs, track the response times and error rates for each model (embedding, NLI, synthesis). This can help diagnose issues that are external to the CNS system itself.</li>
<li><strong>Database Performance</strong>: Monitor query latency and throughput for your persistence layer to ensure it is not becoming a bottleneck.</li>
</ul>
<h3 id="knowledge-quality-and-dynamics-metrics">Knowledge Quality and Dynamics Metrics</h3>
<ul>
<li><strong>SNO Ingestion Rate</strong>: The number of new SNOs being added to the population per hour. This measures the system&rsquo;s overall throughput.</li>
<li><strong>SNO Population Size</strong>: A simple count of the total number of SNOs in the knowledge base.</li>
<li><strong>Average Trust Score</strong>: The mean trust score of all SNOs in the population. A steadily increasing average score suggests the system is successfully refining its knowledge. A sudden drop could indicate a problem with the critic pipeline or the ingestion of low-quality source material.</li>
<li><strong>Synthesis Rate</strong>: The number of new SNOs being generated by the synthesis engine per hour. This measures the system&rsquo;s &ldquo;creativity&rdquo; or rate of discovery.</li>
<li><strong>Synthesis Success Rate</strong>: The percentage of synthesized candidate SNOs that achieve a high enough trust score to be added to the population. A low success rate might indicate that the synthesis prompts need to be optimized (as discussed in Chapter 7).</li>
<li><strong>Critic Score Distribution</strong>: A histogram showing the distribution of scores for each individual critic (Grounding, Logic, Novelty). This can help identify if the system is becoming biased (e.g., only producing logical but unoriginal ideas).</li>
</ul>
<p>By tracking these metrics, you gain crucial visibility into the system&rsquo;s operational health and its effectiveness at the core task of knowledge synthesis, enabling you to tune, scale, and improve it over time.</p>

    </div>

    
    <nav class="article-nav">
        <div class="nav-previous">
            
                <a href="/guides/building-cns-2.0-developers-guide/chapter-6-complete-implementation/" class="nav-link prev-link">
                    <i data-feather="arrow-right"></i>
                    <div class="nav-text">
                        <span class="nav-label">Next</span>
                        <span class="nav-title">Chapter 6: Complete Implementation</span>
                    </div>
                </a>
            
        </div>
        
        <div class="nav-next">
            
                <a href="/guides/building-cns-2.0-developers-guide/chapter-4-synthesis-engine/" class="nav-link next-link">
                    <div class="nav-text">
                        <span class="nav-label">Previous</span>
                        <span class="nav-title">Chapter 4: Generative Synthesis Engine</span>
                    </div>
                    <i data-feather="arrow-left"></i>
                </a>
            
        </div>
    </nav>

    
    <aside class="chapter-summary">
        <h3>Chapter Summary</h3>
        <div class="summary-content">
            
                <p>Integrating all components into a cohesive, operational system.</p>
                <ul>
                    <li>System architecture and workflow</li>
                    <li>Narrative ingestion pipeline</li>
                    <li>Concurrent processing and monitoring</li>
                </ul>
            
        </div>
    </aside>
</article>

            </div>
        </main>

        
        <footer class="site-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-text">
                        <p>&copy; 2025 <a href="https://GTCode.com/" class="footer-link">GTCode.com</a>. Educational content for CNS 2.0 implementation.</p>
                        <p>Based on <a target="_blank" 
                               rel="noopener noreferrer" href="/papers/ResearchProposal-ChiralNarrativeSynthesis_20250617_3.pdf" class="footer-link">CNS 2.0: A Practical Blueprint for Chiral Narrative Synthesis</a> research paper. (20250617 Version 3)</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    
    <script src="/js/navigation.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    
    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}]});"></script>
    
    <script>
        
        if (window.feather) feather.replace();
    </script>
</body>
</html>
